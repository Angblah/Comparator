<!DOCTYPE html>
<html lang="en">

<!-- Include the head tags -->
{% include "partials/header.html" %}
<!-- Include the nav bar for a user who isn't logged in -->
{% include "partials/userNavBar.html" %}

<link href="../static/css/profile.css" rel="stylesheet">

<body>

<div id="all">

    <div class="nav-side">
        <div>
            <center>
            <img id="avatar" src="../static/img/user.png" class="img-responsive hidden-xs"
                 style="background-color: white; border-radius: 100%; height: 30%; width: 30%">
            </center>
            <a id='editAvatar'>
                <i class="fa fa-pencil" aria-hidden="true"></i>
            </a>
            <form id="avatarForm" action="/uploadAvatar" enctype="multipart/form-data" method="POST">
                <input id="avatarUpload" name="avatar" type="file" accept="image/*" style="display: none;" required checked/>
            </form>
            <h1 align="center"><strong>{{ current_user.username }}</strong>'s Profile</h1>
        </div>
    </div>
    <div class="profile-data">
        <button type="submit" class="btn btn-template-main btn-lg" href="#" data-toggle="modal"
                data-target="#change-info-modal">
            <i class="fa fa-pencil" aria-hidden="true"></i>
        </button>
            <div class="prof-cont">
                <h1>USERNAME</h1>
                <h2>{{ current_user.username }}</h2>
            </div>

            <hr>
            <div class="prof-cont">
                <h1>EMAIL</h1>
                <h2>{{ current_user.email }}</h2>
            </div>
            <hr>
            <div class="prof-cont">
                <h1>PASSWORD</h1>
                <h2>********</h2>
            </div>
    </div>

    <!-- *** Change User Info Modal *** -->
    <div class="modal fade" id="change-info-modal" tabindex="-1" role="dialog" aria-labelledby="Change User Info"
         aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="">Change User Info</h4>
                </div>
                <div class="modal-body">
                    <form id="changeInfoForm">

                        <div class="alert alert-success" role="alert" id="successDiv" style="display:none">
                            <strong>Success!</strong>
                            <span>You have successfully changed your information!</span>
                        </div>
                        <div class="alert alert-danger" role="alert" id="overallErrorDiv" style="display:none">
                            <strong>Uh oh!</strong>
                            <span>At least one field must be filled out</span>
                        </div>

                        <div class="alert alert-danger" role="alert" id="usernameErrorDiv" style="display:none">
                            <strong>Uh oh!</strong>
                            <span id="usernameError"></span>
                        </div>
                        <div class="form-group">
                            Change Username
                            <input type="text" name="newUsername" class="form-control" id="newUsername"
                                   placeholder="{{ current_user.username }}">
                        </div>
                        <div class="alert alert-danger" role="alert" id="emailErrorDiv" style="display:none">
                            <strong>Uh oh!</strong>
                            <span id="emailError"></span>
                        </div>
                        <div class="form-group">
                            Change Email
                            <input type="text" name="newEmail" class="form-control" id="newEmail"
                                   placeholder="{{ current_user.email }}">
                        </div>

                        <div class="alert alert-danger" role="alert" id="passwordErrorDiv" style="display:none">
                            <strong>Uh oh!</strong>
                            <span id="passwordError"></span>
                        </div>
                        <div class="form-group">
                            Change Password
                            <input type="password" name="newPassword" class="form-control" id="newPassword"
                                   placeholder="Enter New Password">
                        </div>
                        <div class="form-group">
                            <input type="password" name="confirmPassword" class="form-control" id="confirmPassword"
                                   placeholder="Confirm New Password">
                        </div>
                        <!--TODO: change to use ajax + regular button (assuming modal used)-->
                        <div class="text-center">
                            <button type="submit" id="submitButton" class="btn btn-template-main">Submit</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Include the footer for things like copyright info and JS scripts -->
    {% include "partials/footer.html" %}

</div>
</body>
</html>

<script src="{{ url_for('static', filename='scripts/js/profile.js') }}"></script>
<script src="static/node_modules/jquery/dist/jquery.js" type="text/javascript"></script>
<script src="static/node_modules/blueimp-file-upload/js/vendor/jquery.ui.widget.js" type="text/javascript"></script>
<script src="static/node_modules/blueimp-file-upload/js/jquery.iframe-transport.js" type="text/javascript"></script>
<script src="static/node_modules/blueimp-file-upload/js/jquery.fileupload.js" type="text/javascript"></script>

<script src="static/node_modules/cloudinary-jquery-file-upload/cloudinary-jquery-file-upload.js"></script>


<script>
    $.cloudinary.config({ cloud_name: "comparator"});
    $.getJSON('/getUserAvatarID', {}, function(data) {
        var img_url;
        // default avatar if no avatar stored for user
        if (data == null) {
            img_url = $.cloudinary.url("defaultAvatar.png", {width: 100, height:100, crop:'fill'});
        } else {
            img_url = $.cloudinary.url(data, {width: 100, height:100, crop:'fill'});
        }
        $('#avatar').attr("src", img_url);
    });

    // clicking on pencil icon on avatar prompts user to upload image file
    $("#editAvatar").click(function() {
         $('#avatarUpload').click();
    });

    $("#avatarUpload").change(function() {

        $.ajax({
            url: "/uploadAvatar",
            type: "POST",
            data: this.files[0],
            contentType: false,
            cache: false,
            processData: false,
            success: function(data) {
                var img_url = $.cloudinary.url(data, {width: 100, height:100, crop:'fill'});
                $('#avatar').attr("src", img_url);
            }
        });
    });


</script>

<script>

// TODO: move to util js file and add any additional password requirements
// // returns true if password
// function validatePassword(password, confirm) {

//     if (password != confirm) {
//         return false;
//     } else {
//         return true;
//     }
// };

// function showMessage(label, message) {
//     $('#' + label).text(message);
//     $('#' + label + 'Div').show();
// }

// $(function() {
//     $('#newPassword').add('#confirmPassword').on('focusout', function() {
//         if (validatePassword($('#newPassword').val(), $('#confirmPassword').val())) {
//             $("#passwordErrorDiv").hide();
//         } else {
//             showMessage('passwordError', 'Passwords must match');
//         }
//     });
// });

// $(function() {
//   $('button#submitButton').bind('click', function() {


//     var newUsername = $('#newUsername').val();
//     var newEmail = $('#newEmail').val();
//     var newPassword = $('#newPassword').val();
//     var confirmPassword = $('#confirmPassword').val();

//     if (!validatePassword(newPassword, confirmPassword)) {
//         showMessage('passwordError', 'Passwords must match');
//         return false;
//     } else {
//         $("#passwordErrorDiv").hide();
//     }

//     // at least one field must be filled out
//     if (!newUsername && !newEmail && !newPassword) {
//         $("#overallErrorDiv").show();
//         return false;
//     } else {
//         $("#overallErrorDiv").hide();
//     }


//     $.getJSON('/profile_form', {
//         newUsername: newUsername,
//         newEmail: newEmail,
//         newPassword: newPassword
//     }, function(data) {
//         if (!data.error) {
//             $("#successDiv").show();
//         } else {
//             $("#successDiv").hide();
//         }
//         if (data.username_error) {
//             showMessage('usernameError', data.username_error);
//         } else {
//             $("#usernameErrorDiv").hide();
//         }
//         if (data.email_error) {
//             showMessage("#emailError", data.email_error);
//         } else {
//             $("#emailErrorDiv").hide();
//         }
//     });
//     return false;
//   });
// });


</script>